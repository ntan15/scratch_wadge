\pdfoutput=1

%\documentclass[preprint,10pt]{elsarticle}
\documentclass[preprint,10pt]{article}
%\documentclass[review]{siamart0216}
%\documentclass{siamart0216}

\usepackage{fullpage}
\usepackage[colorlinks=true]{hyperref}

\usepackage{amsmath,amssymb,amsfonts,amsthm}
\theoremstyle{definition}
\newtheorem{definition}{Definition}
\theoremstyle{lemma}
\newtheorem{lemma}{Lemma}
\newtheorem*{remark}{Remark}
\theoremstyle{theorem}
\newtheorem{theorem}{Theorem}
\theoremstyle{assumption}
\newtheorem{assumption}{Assumption}

\usepackage[titletoc,toc,title]{appendix}

\usepackage{array} 
\usepackage{mathtools}
\usepackage{pdfpages}
\usepackage{bm}
\usepackage{bbm}

\usepackage{tikz}
\usepackage[normalem]{ulem}
\usepackage{hhline}

\usepackage{graphicx}
\usepackage{subfig}
\usepackage{color}

%% ====================================== graphics

\usepackage{pgfplots}
\usepackage{pgfplotstable}
\definecolor{markercolor}{RGB}{124.9, 255, 160.65}
\pgfplotsset{
compat=1.3,
width=10cm,
tick label style={font=\small},
label style={font=\small},
legend style={font=\small}
}

\usetikzlibrary{calc}
\usetikzlibrary{intersections} 

%%% START MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.
\newcommand{\logLogSlopeTriangle}[5]
{
    % #1. Relative offset in x direction.
    % #2. Width in x direction, so xA-xB.
    % #3. Relative offset in y direction.
    % #4. Slope d(y)/d(log10(x)).
    % #5. Plot options.

    \pgfplotsextra
    {
        \pgfkeysgetvalue{/pgfplots/xmin}{\xmin}
        \pgfkeysgetvalue{/pgfplots/xmax}{\xmax}
        \pgfkeysgetvalue{/pgfplots/ymin}{\ymin}
        \pgfkeysgetvalue{/pgfplots/ymax}{\ymax}

        % Calculate auxilliary quantities, in relative sense.
        \pgfmathsetmacro{\xArel}{#1}
        \pgfmathsetmacro{\yArel}{#3}
        \pgfmathsetmacro{\xBrel}{#1-#2}
        \pgfmathsetmacro{\yBrel}{\yArel}
        \pgfmathsetmacro{\xCrel}{\xArel}

        \pgfmathsetmacro{\lnxB}{\xmin*(1-(#1-#2))+\xmax*(#1-#2)} % in [xmin,xmax].
        \pgfmathsetmacro{\lnxA}{\xmin*(1-#1)+\xmax*#1} % in [xmin,xmax].
        \pgfmathsetmacro{\lnyA}{\ymin*(1-#3)+\ymax*#3} % in [ymin,ymax].
        \pgfmathsetmacro{\lnyC}{\lnyA+#4*(\lnxA-\lnxB)}
        \pgfmathsetmacro{\yCrel}{\lnyC-\ymin)/(\ymax-\ymin)} % THE IMPROVED EXPRESSION WITHOUT 'DIMENSION TOO LARGE' ERROR.

        % Define coordinates for \draw. MIND THE 'rel axis cs' as opposed to the 'axis cs'.
        \coordinate (A) at (rel axis cs:\xArel,\yArel);
        \coordinate (B) at (rel axis cs:\xBrel,\yBrel);
        \coordinate (C) at (rel axis cs:\xCrel,\yCrel);

        % Draw slope triangle.
        \draw[#5]   (A)-- node[pos=0.5,anchor=north] {}
                    (B)-- 
                    (C)-- node[pos=0.5,anchor=west] {#4}
                    cycle;
    }
}
%%% END MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.

\newcommand{\logLogSlopeTriangleNeg}[5]
{
    % #1. Relative offset in x direction.
    % #2. Width in x direction, so xA-xB.
    % #3. Relative offset in y direction.
    % #4. Slope d(y)/d(log10(x)).
    % #5. Plot options.

    \pgfplotsextra
    {
        \pgfkeysgetvalue{/pgfplots/xmin}{\xmin}
        \pgfkeysgetvalue{/pgfplots/xmax}{\xmax}
        \pgfkeysgetvalue{/pgfplots/ymin}{\ymin}
        \pgfkeysgetvalue{/pgfplots/ymax}{\ymax}

        % Calculate auxilliary quantities, in relative sense.
        \pgfmathsetmacro{\xArel}{#1}
        \pgfmathsetmacro{\yArel}{#3}
        \pgfmathsetmacro{\xBrel}{#1-#2}
        \pgfmathsetmacro{\yBrel}{\yArel}
        \pgfmathsetmacro{\xCrel}{\xArel}

        \pgfmathsetmacro{\lnxB}{\xmin*(1-(#1-#2))+\xmax*(#1-#2)} % in [xmin,xmax].
        \pgfmathsetmacro{\lnxA}{\xmin*(1-#1)+\xmax*#1} % in [xmin,xmax].
        \pgfmathsetmacro{\lnyA}{\ymin*(1-#3)+\ymax*#3} % in [ymin,ymax].
        \pgfmathsetmacro{\lnyC}{\lnyA+#4*(\lnxA-\lnxB)}
        \pgfmathsetmacro{\yCrel}{\lnyC-\ymin)/(\ymax-\ymin)} % THE IMPROVED EXPRESSION WITHOUT 'DIMENSION TOO LARGE' ERROR.

        % Define coordinates for \draw. MIND THE 'rel axis cs' as opposed to the 'axis cs'.
        \coordinate (A) at (rel axis cs:\xArel,\yArel);
        \coordinate (B) at (rel axis cs:\xBrel,\yBrel);
        \coordinate (C) at (rel axis cs:\xCrel,\yCrel);

        % Draw slope triangle.
        \draw[#5]   (A)-- node[pos=.5,anchor=south] {}
                    (B)-- 
                    (C)-- node[pos=0.5,anchor=west] {#4}
                    cycle;
    }
}
%%% END MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.

%%% START MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.
\newcommand{\logLogSlopeTriangleFlipNeg}[5]
{
    % #1. Relative offset in x direction.
    % #2. Width in x direction, so xA-xB.
    % #3. Relative offset in y direction.
    % #4. Slope d(y)/d(log10(x)).
    % #5. Plot options.

    \pgfplotsextra
    {
        \pgfkeysgetvalue{/pgfplots/xmin}{\xmin}
        \pgfkeysgetvalue{/pgfplots/xmax}{\xmax}
        \pgfkeysgetvalue{/pgfplots/ymin}{\ymin}
        \pgfkeysgetvalue{/pgfplots/ymax}{\ymax}

        % Calculate auxilliary quantities, in relative sense.
        %\pgfmathsetmacro{\xArel}{#1}
        %\pgfmathsetmacro{\yArel}{#3}
        \pgfmathsetmacro{\xBrel}{#1-#2}
        \pgfmathsetmacro{\yBrel}{#3}
        \pgfmathsetmacro{\xCrel}{#1}

        \pgfmathsetmacro{\lnxB}{\xmin*(1-(#1-#2))+\xmax*(#1-#2)} % in [xmin,xmax].
        \pgfmathsetmacro{\lnxA}{\xmin*(1-#1)+\xmax*#1} % in [xmin,xmax].
        \pgfmathsetmacro{\lnyA}{\ymin*(1-#3)+\ymax*#3} % in [ymin,ymax].
        \pgfmathsetmacro{\lnyC}{\lnyA+#4*(\lnxA-\lnxB)}
        \pgfmathsetmacro{\yCrel}{\lnyC-\ymin)/(\ymax-\ymin)} % THE IMPROVED EXPRESSION WITHOUT 'DIMENSION TOO LARGE' ERROR.

	\pgfmathsetmacro{\xArel}{\xBrel}
        \pgfmathsetmacro{\yArel}{\yCrel}

        % Define coordinates for \draw. MIND THE 'rel axis cs' as opposed to the 'axis cs'.
        \coordinate (A) at (rel axis cs:\xArel,\yArel);
        \coordinate (B) at (rel axis cs:\xBrel,\yBrel);
        \coordinate (C) at (rel axis cs:\xCrel,\yCrel);

        % Draw slope triangle.
        \draw[#5]   (A)-- node[pos=0.5,anchor=east] {#4}
                    (B)-- 
                    (C)-- node[pos=0.5,anchor=north] {1}
                    cycle;
    }
}
%%% END MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.


%%% START MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.
\newcommand{\logLogSlopeTriangleFlip}[5]
{
    % #1. Relative offset in x direction.
    % #2. Width in x direction, so xA-xB.
    % #3. Relative offset in y direction.
    % #4. Slope d(y)/d(log10(x)).
    % #5. Plot options.

    \pgfplotsextra
    {
        \pgfkeysgetvalue{/pgfplots/xmin}{\xmin}
        \pgfkeysgetvalue{/pgfplots/xmax}{\xmax}
        \pgfkeysgetvalue{/pgfplots/ymin}{\ymin}
        \pgfkeysgetvalue{/pgfplots/ymax}{\ymax}

        % Calculate auxilliary quantities, in relative sense.
        %\pgfmathsetmacro{\xArel}{#1}
        %\pgfmathsetmacro{\yArel}{#3}
        \pgfmathsetmacro{\xBrel}{#1-#2}
        \pgfmathsetmacro{\yBrel}{#3}
        \pgfmathsetmacro{\xCrel}{#1}

        \pgfmathsetmacro{\lnxB}{\xmin*(1-(#1-#2))+\xmax*(#1-#2)} % in [xmin,xmax].
        \pgfmathsetmacro{\lnxA}{\xmin*(1-#1)+\xmax*#1} % in [xmin,xmax].
        \pgfmathsetmacro{\lnyA}{\ymin*(1-#3)+\ymax*#3} % in [ymin,ymax].
        \pgfmathsetmacro{\lnyC}{\lnyA+#4*(\lnxA-\lnxB)}
        \pgfmathsetmacro{\yCrel}{\lnyC-\ymin)/(\ymax-\ymin)} % THE IMPROVED EXPRESSION WITHOUT 'DIMENSION TOO LARGE' ERROR.

	\pgfmathsetmacro{\xArel}{\xBrel}
        \pgfmathsetmacro{\yArel}{\yCrel}

        % Define coordinates for \draw. MIND THE 'rel axis cs' as opposed to the 'axis cs'.
        \coordinate (A) at (rel axis cs:\xArel,\yArel);
        \coordinate (B) at (rel axis cs:\xBrel,\yBrel);
        \coordinate (C) at (rel axis cs:\xCrel,\yCrel);

        % Draw slope triangle.
        \draw[#5]   (A)-- node[pos=0.5,anchor=east] {#4}
                    (B)-- 
                    (C)-- node[pos=0.5,anchor=south] {}
                    cycle;
    }
}
%%% END MACRO FOR ANNOTATION OF TRIANGLE WITH SLOPE %%%.


\renewcommand{\topfraction}{0.85}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.75}


\newcommand{\bbm}[1]{\mathbbm{#1}}
\newcommand{\bs}[1]{\boldsymbol{#1}}
\newcommand{\equaldef}{\stackrel{\mathrm{def}}{=}}


\newcommand{\mb}[1]{\mathbf{#1}}
\newcommand{\mbb}[1]{\mathbb{#1}}
\newcommand{\mc}[1]{\mathcal{#1}}

\renewcommand{\hat}{\widehat}
\newcommand{\td}[2]{\frac{{\rm d}#1}{{\rm d}{\rm #2}}}
\newcommand{\pd}[2]{\frac{\partial#1}{\partial#2}}
\newcommand{\pdn}[3]{\frac{\partial^{#3}#1}{\partial#2^{#3}}}
\newcommand{\snor}[1]{\left| #1 \right|}
\newcommand{\nor}[1]{\left\| #1 \right\|}
\newcommand{\LRp}[1]{\left( #1 \right)}
\newcommand{\LRs}[1]{\left[ #1 \right]}
\newcommand{\LRa}[1]{\left\langle #1 \right\rangle}
\newcommand{\LRb}[1]{\left| #1 \right|}
\newcommand{\LRc}[1]{\left\{ #1 \right\}}
\newcommand{\LRceil}[1]{\left\lceil #1 \right\rceil}
\newcommand{\LRl}[1]{\left. \LRp{#1} \right|}
\newcommand{\jump}[1] {\ensuremath{\llbracket#1\rrbracket}}
\newcommand{\avg}[1] {\ensuremath{\LRc{\!\{#1\}\!}}}
\newcommand{\Grad} {\ensuremath{\nabla}}
\newcommand{\note}[1]{{\color{blue}{#1}}}
\renewcommand{\d}{\partial}


\newcommand{\LK}{L^2\LRp{D^k}}
\newcommand{\LdK}{L^2\LRp{\partial D^k}}
\newcommand{\Dhat}{\widehat{D}}
\newcommand{\Lhat}{L^2\LRp{\Dhat}}


\newcommand*\diff[1]{\mathop{}\!{\mathrm{d}#1}} % d in integrand

\date{}
\author{Jesse Chan, Lucas Wilcox}
\title{Discretely entropy stable weight-adjusted discontinuous Galerkin methods: curvilinear meshes and GPU acceleration}
\graphicspath{{./figs/}}


\begin{document}

\maketitle

\begin{abstract}
Things to include: entropy conservation and stability on curvilinear meshes, choosing geometric factors to ensure constant state preservation, high order accuracy.  Computational considerations for curvilinear meshes.  
\end{abstract}

\section{Introduction}

Introducing WADG \cite{chan2016weight1,chan2016weight2}.  

Matrix WADG: GPU efficiency of WADG vs storing weighted inverses \cite{chan2017weight}.  

\section{Nonlinear conservation laws and the compressible Euler equations}

This work addresses is high order schemes for the following system of $n$ nonlinear conservation laws in $d$ dimensions 
\begin{equation}
\pd{\bm{u}}{t} + \sum_{j=1}^d\pd{\bm{f}_j(\bm{u})}{x_j}  = 0, \qquad \bm{u} \in \mathbb{R}^n, \qquad \bm{f}_j : \mathbb{R}^n\rightarrow \mathbb{R}^n,
\label{eq:nonlineqs}
\end{equation}
where $\bm{u}(\bm{x},t)$ denote the \emph{conservative variables} for this system.  We will specify boundary conditions in a later section.  

We are interested in nonlinear conservation laws for which an entropy function $U(\bm{u})$ exists, where $U(\bm{u})$ is convex with respect to the conservative variables $\bm{u}$.  If this function exists, then it is possible to define \emph{entropy variables} $\bm{v}(\bm{u}) = \pd{U}{\bm{u}}$.  These functions symmetrize the system of nonlinear conservation laws (\ref{eq:nonlineqs}) \cite{hughes1986new}.  

It can be shown (see, for example, \cite{mock1980systems}) that symmetrization is equivalent to the existence of an entropy flux function $F(\bm{u})$ and entropy potential $\psi$ such that
\[
\bm{v}^T \pd{\bm{f}}{\bm{u}} = \pd{F(\bm{u})}{\bm{u}}^T, \qquad \psi(\bm{v}) = \bm{v}^T\bm{f}(\bm{u}(\bm{v})) - F(\bm{u}(\bm{v})), \qquad \psi'(\bm{v}) = \bm{f}(\bm{u}(\bm{v})).
\]
Physically relevant solutions of (\ref{eq:nonlineqs}) can be shown to satisfy an entropy inequality by multiplying (\ref{eq:nonlineqs}) by $\bm{v}(\bm{u})$. Using the definition of the entropy flux along with the chain rule yields 
\[
\pd{U(\bm{u})}{t} + \sum_{j=1}^d \pd{F_j(\bm{u})}{x_j} \leq 0.
\]
Let $\Omega\mathbb{R}^d$ now be a closed domain with boundary $\partial \Omega$.  Integrating over $\Omega$ an using Gauss' theorem on the spatial derivative yields
\begin{equation}
\int_{\Omega}\pd{U(\bm{u})}{t}\diff{x} + \int_{\partial \Omega} \sum_{j=1}^d \LRp{\bm{v}(\bm{u})^T\bm{f}_j(\bm{u}) - \psi_j\LRp{\bm{v}(\bm{u})}}n_j \diff{x} \leq 0,
\label{eq:entropyineq}
\end{equation}
where $\bm{n} = \LRp{n_1,\ldots,n_d}^T$ denotes the unit outward normal vector on $\partial \Omega$.  

\subsection{Standard discontinuous Galerkin formulations and the $L^2$ projection}


\note{Discuss standard DG formulations and their disadvantages: not entropy stable due to the loss of the chain rule, and storage costs of inverting the mass matrix.  }

\note{ Introduce mesh and elements $D^k$, as well as $L^2$ projection operator.}
For $u \in L^2\LRp{\widehat{D}}$, 
\begin{equation}
\int_{\widehat{D}} \Pi_N u v \diff{\hat{\bm{x}}} = \int_{\widehat{D}} u v \diff{\hat{\bm{x}}}, \qquad \forall v\in P^N\LRp{\hat{D}}.
\label{eq:l2proj}
\end{equation}

Discontinuous Galerkin methods have been very widely applied to systems of nonlinear conservation laws (\ref{eq:nonlineqs}) \cite{cockburn1989tvb, cockburn1998runge, cockburn2001devising, karniadakis2013spectral}.  The development of new discontinuous Galerkin methods for nonlinear conservation laws have focused heavily on the choice of numerical flux \cite{qiu2006numerical} or the development of  slope limiters \cite{krivodonova2007limiters, zhang2012maximum, dumbser2014posteriori} and artificial viscosity strategies \cite{persson2006sub, barter2010shock, klockner2011viscous}.  However, the treatment of the underlying volume discretization remains relatively unchanged between each of these approaches.  

Ignoring terms involving filters, limiters, or artificial viscosity, a semi-discrete ``weak'' DG formulation  for (\ref{eq:nonlineqs}) can be given locally over an element $D^k$: find $\bm{u}\in \LRp{P^N\LRp{D^k}}^n$ such that
\begin{align}
\int_{D^k} \LRp{\pd{\bm{u}}{t}\cdot \bm{v} - \sum_{j=1}^d\bm{f}_j(\bm{u}) \cdot \pd{\bm{v}}{x_i}} \diff{\bm{x}} 
+ \sum_{j=1}^d \int_{\partial D^k} \LRp{\bm{f}^*_j\LRp{\bm{u}^+,\bm{u}} }\cdot \bm{v} n_j  \diff{\bm{x}} = 0, \qquad \forall \bm{v}\in \LRp{P^N\LRp{D^k}}^n,
\label{eq:weakdg}
\end{align}
where the numerical flux $\bm{f}^*$ is a function of the solution $\bm{u}$ on both $D^k$ and neighboring elements.  

Unfortunately, solutions to (\ref{eq:weakdg}) do not (in general) obey a discrete version of the entropy inequality (\ref{eq:entropyineq}).  Since (\ref{eq:entropyineq}) is a generalized statement of energy stability, this implies that there is no guarantee that the solution does not blow up.  

For polynomial approximation spaces, $\pd{\bm{v}}{x_i}$ is polynomial.  Then, mapping (\ref{eq:weakdg}) back to the reference element $\hat{D}$ and using the $L^2$ projection and (\ref{eq:l2proj}), we have that
\[
\int_{D^k} \bm{f}_j(\bm{u}) \cdot \pd{\bm{v}}{x_i} \diff{\bm{x}} = \int_{\hat{D}} \Pi_N \bm{f}_j(\bm{u}) \cdot \pd{\bm{v}}{x_i} J\diff{\bm{x}}.
\]
Thus, integrating by parts (\ref{eq:weakdg}) recovers a ``strong'' DG formulation involving the projection operator
\begin{align}
&\int_{D^k} \LRp{\pd{\bm{u}}{t} - \sum_{j=1}^d \pd{\Pi_N \bm{f}_j(\bm{u})}{x_j}} \cdot \bm{v} \diff{\bm{x}} \nonumber\\
&+ \sum_{j=1}^d \int_{\partial D^k} \LRp{\bm{f}^*_j\LRp{\bm{u}^+,\bm{u}} - \Pi_N\bm{f}_j(\bm{u})}\cdot \bm{v} n_j  \diff{\bm{x}} = 0, \qquad \forall \bm{v}\in \LRp{P^N\LRp{D^k}}^n.  
\label{eq:strongdg}
\end{align}
We note that it is not strictly necessary to introduce the projection operator; however, constructing a ``strong'' DG formulation without a projection operator requires an analytical expression for derivatives of the nonlinear flux function $\bm{f}_j\LRp{\bm{u}}$, which can be complex or expensive to compute.  Moreover, because polynomial quadrature rules are typically used in practice to evaluate integrals, 
it is not possible to use integration by parts when the nonlinear flux function is rational due to errors in approximating integrals.  Introducing the projection operator resolves both issues, as the integrands involved in integration by parts are polynomials of degree $2N-1$, for which efficient quadratures exist. 



\section{A discretely stable and low-storage DG method on curved meshes}

\subsection{A weight-adjusted approximation to the curvilinear mass matrix}

The $L^2$ projection on a curvilinear domain $\Pi_N^k$ is defined as
\[
\LRp{\Pi_N^k u,v}_{D^k} = \LRp{J \Pi_N^k u,v}_{\hat{D}} = \LRp{uJ,v}_{\hat{D}} = \LRp{u,v}_{D^k}, \qquad \forall v\in V_h.
\]


To define a weight-adjusted approximation to the curvilinear $L^2$ inner product, we first define the operator $T_{w}^{-1}$ as follows
\[
\LRp{wT_{w}^{-1} u,v}_{\hat{D}} = \LRp{ u,v}_{\hat{D}}, \qquad \forall v\in V_h.
\]
Taking $w = 1/J$ then provides an approximation of the curvilinear $L^2$ inner product
\[
\LRp{J u,v}_{\hat{D}}\approx \LRp{T_{1/J}^{-1} u,v}_{\hat{D}}, \qquad \forall u,v\in V_h.
\]
This forms the basis of the weight-adjusted approximation of weighted $L^2$ inner products.  

\subsection{Weight-adjusted projection} 
We now define the weight-adjusted projection operator $P_N$ as 
\[
P_N u = \Pi_N\LRp{\frac{1}{J}\Pi_N\LRp{uJ}}.
\]
Note that $P_N$ is self-adjoint with respect to the $J$-weighted $L^2$ inner product
\begin{equation}
\LRp{J P_N u, v} = \LRp{\Pi_N\LRp{\frac{1}{J}\Pi_N\LRp{uJ}}, vJ} = \LRp{uJ, \Pi_N\LRp{\frac{1}{J}\Pi_N\LRp{vJ}}} =  \LRp{uJ, P_N v}.
\label{eq:PNsym}
\end{equation}
Furthermore, using that $T_{1/J}^{-1}$ is self-adjoint for $v \in V_h$ with respect to the $L^2$ inner product \cite{chan2016weight1}, we have that a projection-like property holds for the weight-adjusted $L^2$ inner product
\begin{equation}
\LRp{T_{1/J}^{-1} P_N u,v} = \LRp{ \frac{1}{J}\Pi_N(uJ),T_{1/J}^{-1}v} = \LRp{\Pi_N(u J),v} = \LRp{u J,v}, \qquad \forall v\in V_h.
\label{eq:PNproj}
\end{equation}


Let $\Pi_N^k u$ be the $L^2$ projection of $u$ with respect to the weighted (curvilinear) $L^2$ inner product.  We observe in numerical experiments that for a fixed geometric mapping, $\nor{\Pi_N^k u - P_N u}_{L^2\LRp{\Omega}} = O(h^{N+2})$.  Because the difference between the $L^2$ and WADG projection is superconvergent, the results are indistinguishable for a fixed geometric mapping.  

We can prove this bound using results from \cite{chan2016weight1,chan2016weight2}.  The first theorem we need shows that $T_{1/J}^{-1}$ can be used to approximate weighted curvilinear $L^2$ inner products with order $(2N+2)$ accuracy.  
\begin{theorem}
\label{thm:moment}
Let $u\in W^{N+1,2}\LRp{D^k}$ and $v\in V_h\LRp{D^k}$.  Then, 
\begin{align*}
&\LRb{\LRp{u,vJ}_{\hat{D}} - \LRp{T^{-1}_{1/J}u,v}_{\hat{D}}} \leq \\
&Ch^{2N+2}\nor{J}_{L^{\infty}\LRp{D^k}}  \nor{\frac{1}{J}}_{L^{\infty}\LRp{D^k}}^2 \nor{J}^2_{W^{N+1,\infty}\LRp{D^k}}\nor{u}_{W^{N+1,2}\LRp{D^k}}\nor{v}_{W^{N+1,2}\LRp{D^k}}.
\end{align*}
\end{theorem}
\begin{proof}
The proof involves straightforward adaptations of Theorem 4, Theorem 5, and Theorem 6 in \cite{chan2016weight1} to the reference element $\hat{D}$.  
\end{proof}
The next result we need is a generalized inverse inequality.  
\begin{lemma}
\label{lemma:sobolev}
Let $v \in P^N\LRp{D^k}$, and let $h = {\rm diam}\LRp{D^k}$.  Then,
\[
\nor{v}_{W^{N+1,2}\LRp{D^k}} \leq C_{N} h^{-N} \nor{v}_{L^2\LRp{D^k}}.
\]
where $C_{N}$ is independent of $h$.
\end{lemma}
\begin{proof}
The result is the consequence of a scaling argument and a Rayleigh quotient bound involving the largest eigenvalue of the generalized eigenvalue problem  
\[
\bm{K}_N\bm{u} = \lambda\bm{M}\bm{u},
\]
where $\bm{M}$ is the $L^2$ mass matrix over $D^k$ and $\bm{K}_N$ is the Gram matrix corresponding to the Sobolev inner product for $W^{N+1,2}\LRp{D^k}$.  We note that the constant $C_N$ depends on the largest eigenvalue, which in turn depends on the order $N$ and dimension $d$.  
\end{proof}

We can now prove that $P_Nu$ is superconvergent to the curvilinear $L^2$ projection $\Pi_N^k u$
\begin{theorem}
Let $u \in W^{N+1,2}\LRp{D^k}$.  The difference between the $L^2$ projection $\Pi^k_Nu$ and the weight-adjusted projection $P_Nu$ is
\[
\nor{\Pi_N^k u - P_N u}_{L^2\LRp{D^k}} \leq C\nor{J}_{L^{\infty}\LRp{D^k}}  \nor{\frac{1}{J}}_{L^{\infty}\LRp{D^k}}^2 \nor{J}^2_{W^{N+1,\infty}\LRp{D^k}} h^{N+2}\nor{u}_{W^{N+1,2}\LRp{D^k}}.
\]
where $C$ is a mesh-independent constant.
\end{theorem}

\begin{proof}
Let $\Pi_N^k u$ be the $L^2$ projection over the curved element $D^k$, such that
\[
\LRp{J\Pi_N^k u,v} = \LRp{u J,v}, \qquad \forall v\in V_h.
\]
Using the fact that $P_N u$ satisfies an analogous property (\ref{eq:PNproj}),  we can rewrite the norm of the difference between the weight-adjusted and $L^2$ projections
\[
\nor{\Pi_N^k  u - P_N u}_{L^2\LRp{D^k}}^2 = \LRp{\Pi_N^k  u - P_N u,vJ}_{\hat{D}}, \qquad v = \Pi_N^k  u - P_N u.
\]
Because $v \in P^N\LRp{D^k}$, we can also evaluate the squared error as
\begin{align*}
\nor{\Pi_N^k  u - P_N u}_{L^2\LRp{D^k}}^2 &= \LRb{\LRp{\Pi_N^k ,vJ}_{\hat{D}} - \LRp{P_N u,vJ}_{\hat{D}}}\\
& = \LRb{\LRp{u,vJ}_{\hat{D}} - \LRp{P_N u,vJ}_{\hat{D}}} = \LRb{\LRp{T_{1/J}^{-1}P_N u,v}_{\hat{D}} - \LRp{JP_N u,v}_{\hat{D}}}.
\end{align*}
Applying Theorem~\ref{thm:moment} and Lemma~\ref{lemma:sobolev} then yields that 
\begin{align*}
\nor{\Pi_N^k u - P_N u}_{L^2\LRp{D^k}}^2 &\leq Ch^{2N+2} C_J\nor{u}_{W^{N+1,2}\LRp{D^k}}
\nor{v}_{W^{N+1,2}\LRp{\hat{D}}} \\
&\leq Ch^{N+2} C_J\nor{u}_{W^{N+1,2}\LRp{D^k}}\nor{v}_{L^2\LRp{D^k}},
\end{align*}
where $C_J$ is a mesh-independent constant depending on $J$.  Dividing through by 
\[
\nor{v}_{L^2\LRp{D^k}} = \nor{\Pi^k_N u - P_N u}_{L^2\LRp{D^k}}
\]
 gives the desired result.  % $C_J = \nor{J}_{L^{\infty}} \nor{\frac{1}{J}}^2_{L^\infty} \nor{J}^2_{W^{N+1,\infty}\LRp{\hat{D}}}$.
\end{proof}


%\section{Flux differencing for affine meshes}
%
%Let $\bm{F}(\bm{U})$ denote the flux matrix whose rows are 
%\[
%\bm{F}(\bm{U}) = \LRp{
%\begin{array}{c}
%\bm{F}_x \\
%\bm{F}_y
%\end{array}
%}.
%\]
%The conservation law of interest is the following
%\[
%\pd{\bm{U}}{t} + \Grad \cdot \bm{F}(\bm{U}) = 0,
%\]
%where the divergence is taken over each column of $\bm{F}(\bm{U})$.  
%
%Define the global DG divergence
%\begin{align*}
%\LRp{\Grad_h \cdot \bm{u},vw}_{\Omega} &= \sum_k \LRp{\Grad \cdot \Pi_N\bm{u},vw}_{D^k} \\
%& + \frac{1}{2}\LRa{ \bm{u}^+ - \Pi_N\bm{u},vw\bm{n}}_{\d D^k} +  \frac{1}{2}\LRa{ \bm{u} - \Pi_N\bm{u},\Pi_N\LRp{vw}\bm{n}}_{\d D^k}.
%\end{align*}
%This is equivalent to defining
%\[
%\Grad_h \cdot\bm{u} = \sum_i D^i_h \bm{u}_i.  
%\]
%Let $\bm{f}^i_S(\bm{u}_L,\bm{u}_R)$ for $i= 1,\ldots,d$ denote the multi-dimensional entropy conservative flux of Tadmor \cite{tadmor1987numerical}, such that
%\[
%\LRp{\bm{v}_L-\bm{v}_R}^T\bm{f}^i_S(\bm{u}_L,\bm{u}_R) = \psi_{i,L} - \psi_{i,R}
%\]
%where $\psi_i$ denotes the $i$th component of the entropy potential.  We concatenate these components together into a matrix $\bm{f}_S$ whose $i$th row is $\bm{f}^i_S$
%\[
%\bm{f}_S = \LRs{\bm{f}^1_S,\ldots,\bm{f}^d_S}^T.  
%\]
%\begin{theorem}
%\label{thm:ec}
%The semi-discrete DG discretization 
%\[
%\LRp{\pd{\bm{u}}{t} + 2\LRl{{\Grad_h\cdot \bm{f}_S(\bm{u},\bm{u}')}}_{\bm{x}'=\bm{x}},\bm{w}}_{\Omega} = 0
%\]
%is entropy conservative.  
%\end{theorem}
%\begin{proof}
%Take $\bm{w} = \bm{v}$.  The time term reduces to $\pd{S(\bm{u})}{t}$ by the chain rule.  The spatial term is then
%\begin{align*}
%2\LRp{\LRl{{\Grad_h\cdot \bm{f}_S(\bm{u},\bm{u}')}}_{\bm{x}'=\bm{x}},\bm{v}} &= \LRp{\LRl{{\Grad_h\cdot \bm{f}_S(\bm{u},\bm{u}')}\bm{v}'}_{\bm{x}'=\bm{x}},{1}} + \sum_{i=1}^d  \LRp{\LRl{{D^i_h \bm{f}^i_S(\bm{u},\bm{u}')}}_{\bm{x}'=\bm{x}},\bm{v}} \\
%&= \sum_{i=1}^d\LRa{\bm{f}^i_S(\bm{u},\bm{u}),\bm{v}\bm{n}_i} - \LRp{\LRl{{D^i_h \LRp{\LRp{\bm{v}'-\bm{v}}^T\bm{f}^i_S(\bm{u},\bm{u}')}}}_{\bm{x}'=\bm{x}},{1}}
%\end{align*}
%The boundary term is simplified by noting that $\bm{f}^i_S(\bm{u},\bm{u}) = \bm{f}^i(\bm{u})$.  
%Applying properties of the entropy conservative flux yields
%\[
%\LRp{\bm{v}'-\bm{v}}^T\bm{f}^i_S(\bm{u},\bm{u}') = \psi_i' - \psi_i,
%\]
%which simplifies the final volume term to
%\[
%\LRp{\LRl{D^i_h \LRp{\psi_i' - \psi_i}}_{\bm{x}'=\bm{x}},{1}} = \LRa{-\psi_i\bm{n}_i,1}.
%\]
%\end{proof}

\section{Curved meshes}

Let $\bm{G}$ denote the Jacobian of the geometric mapping
\[
\bm{G}_{ij} = \pd{\hat{\bm{x}}_j}{\bm{x}_i},
\]
and let $J$ denote the determinant of $\bm{G}$.  One can show that
\[
\hat{\Grad} \cdot \LRp{J\bm{G}^T} = 0, \qquad \hat{\Grad} \cdot \LRp{J\bm{G}^T\bm{u}} = \Grad \cdot \bm{u}
\]
at the continuous level.  We also have that the mapped normals obey the property
\[
J\bm{G} \hat{\bm{n}}\hat{J}^f = \bm{n}J^f.
\]
At the continuous level, the physical gradient and divergence satisfy
\[
\LRp{\Grad u, \bm{v}}_{D^k} = \LRp{J\bm{G} \hat{\Grad} u,\bm{v}}_{\hat{D}}, \qquad \LRp{\Grad\cdot \bm{u},v}_{D^k} = \LRp{\hat{\Grad}\cdot \LRp{J\bm{G}^T u},\bm{v}}_{\hat{D}}, 
\]
as well as a corresponding integration by parts property.  

\subsection{Flux differencing for curvilinear meshes}

We introduce a ``reference'' global DG derivative, which is defined (for $v\in V_h$ but $u,w\not\in V_h$)
\begin{align*}
\LRp{\hat{D}^i_h u,vw}_{\Omega} &= \sum_k \LRp{\pd{\Pi_N\bm{u}}{\hat{\bm{x}}_i},vw}_{\hat{D}} 
 + \frac{1}{2}\LRa{ \bm{u}^+ - \Pi_N\bm{u},vw\hat{\bm{n}}_i}_{\d \hat{D}} +  \frac{1}{2}\LRa{ \bm{u} - \Pi_N\bm{u},\Pi_N\LRp{vw}\hat{\bm{n}}_i}_{\d \hat{D}}.
\end{align*}
%\begin{align*}
%\LRp{\hat{\Grad}_h \cdot \bm{u},vw}_{\Omega} &= \sum_k \LRp{\hat{\Grad} \cdot \Pi_N\bm{u},vw}_{\hat{D}} \\
%& + \frac{1}{2}\LRa{ \bm{u}^+ - \Pi_N\bm{u},vw\hat{\bm{n}}}_{\d \hat{D}} +  \frac{1}{2}\LRa{ \bm{u} - \Pi_N\bm{u},\Pi_N\LRp{vw}\hat{\bm{n}}}_{\d \hat{D}}.
%\end{align*}
We use this to define a reference DG divergence
\begin{align*}
\hat{\Grad}_h \cdot \bm{u} = \sum_{i=1}^d \hat{D}^i_h \bm{u}_i.
\end{align*}
We next introduce two physical DG divergences based on the reference DG divergence.  The a ``conservative'' DG divergence is defined using the reference DG divergence operator
\[
\Grad^c_h \cdot \bm{u} = \hat{\Grad}_h \cdot \LRp{J\bm{G}^T\bm{u}}.  
\]

We also introduce the ``non-conservative'' divergence 
\[
\Grad_h^{nc} \cdot \bm{u} = \LRp{J\bm{G}\hat{\Grad}_h}\cdot \bm{u} = \sum_{i=1}^d \sum_{j=1}^d J\bm{G}_{ij} \hat{D}^j_h\bm{u}_i.
\]
Unless $J\bm{G}$ is element-wise constant,
\[
\hat{\Grad}_h\cdot\LRp{J\bm{G}^T\bm{u}} \neq \LRp{J\bm{G}\hat{\Grad}_h}\cdot\bm{u}, 
\]
due to the presence of the projection operator $\Pi_N$ in the definition of $\hat{\Grad}_h$.  

Instead of choosing one definition over the other, it was shown in \cite{wintermeyer2017entropy} that stability is achieved when using the average of these two definitions of the physical gradient.  The following lemma describes how to implement this within the flux differencing framework.
\begin{lemma}
Let $\bm{u}^k(\bm{x},\bm{x}')$ be defined as
\[
\bm{u}^k(\bm{x},\bm{x}') = \avg{J\bm{G}^T}\bm{u} = \LRp{\frac{J(\bm{x})\bm{G}^T(\bm{x}) + J(\bm{x}')\bm{G}^T(\bm{x}')}{2}}\bm{u}.
\]
Applying the reference global DG divergence to $\bm{u}^k$ is equivalent to averaging both definitions of the global DG divergence
\[
\LRl{{\hat{\Grad}_h \cdot \bm{u}^k(\bm{x},\bm{x}')}}_{\bm{x}'=\bm{x}} = \frac{1}{2}\LRp{\hat{\Grad}_h\cdot\LRp{J\bm{G}^T\bm{u}} + \LRp{J\bm{G}\hat{\Grad}_h}\cdot\bm{u}} = \frac{1}{2}\LRp{\Grad^c_h\cdot \bm{u} + \Grad_h^{nc}\cdot\bm{u}}.
\]
\end{lemma}
\begin{proof}
\note{TBD.}
\end{proof}

We now have the following curvilinear generalization of Theorem~\ref{thm:ec}
\begin{theorem}
\label{thm:ec_curvi}
Let $\bm{u}_{\bm{v}} = \bm{u}\LRp{P_N\bm{v}(\bm{u})}$.  Then, the semi-discrete DG discretization 
\[
\LRp{\pd{\bm{u}}{t} + 2\LRl{\hat{\Grad}_h\cdot \bm{f}^k_S(\bm{u}_{\bm{v}},\bm{u}_{\bm{v}}')}_{\bm{x}'=\bm{x}},\bm{w}} = 0, \qquad \bm{f}^k_S(\bm{u}_L,\bm{u}_R) = \avg{J\bm{G}^T}\bm{f}_S(\bm{u}_L,\bm{u}_R).
\]
is entropy conservative on curvilinear meshes.  
\end{theorem}
\begin{proof}
Take $\bm{w} = \Pi_N\LRp{\frac{1}{J}\Pi_N\LRp{ \bm{v}J}}$.  

\end{proof}




\section{Free stream preservation}

We seek conditions for which free-stream preservation 
\[
\pd{\bm{u}}{t} = \Grad_h \cdot \bm{u} = 0
\]
is satisfied if $\bm{u}$ constant.  Free stream preservation is not always maintained at the discrete level in 3D due to the fact that geometric factors are higher degree polynomials than the corresponding discrete space \cite{kopriva2006metric, johnen2013geometrical}.  For curvilinear meshes, $\hat{\Grad}\cdot{J\bm{G}^T} \neq 0$ due to polynomial aliasing of geometric factors.  

This can be remedied by using an interpolation of the curl-conservative form of the geometric factors, which ensures that $\hat{\Grad}\cdot\LRp{J\bm{G}^T} = 0$ locally \cite{visbal2002use, kopriva2006metric}.  However, because the geometric factors are computed by applying the curl, the geometric factors are approximated as degree $(N-1)$ polynomials rather than degree $N$ polynomials, which can reduce accuracy.  We take a different approach, based on a strategy described in \cite{fernandez2016simultaneous, crean2018entropy}.  

Integrating by parts the DG formulation yields, for any constant $\bm{u}$
\begin{align*}
\LRp{\Grad_h \cdot \bm{u},v}_{\Omega} &= \sum_k \LRp{\hat{\Grad} \cdot \LRp{J\bm{G}^T\bm{u}},v }_{\hat{D}} + \LRa{J\bm{G}^T\bm{u} - \Pi_N \LRp{J\bm{G}^T\bm{u}}, v \hat{\bm{n}}}_{\d \hat{D}}\\
&= \sum_k \LRp{-J\bm{G}^T\bm{u},\hat{\Grad} v }_{\hat{D}} + \LRa{\LRp{J\bm{G}\hat{\bm{n}}}^T\bm{u}, v }_{\d \hat{D}}\\
&= \sum_k \LRp{-J\bm{G}^T\bm{u},\hat{\Grad} v }_{\hat{D}} + \LRa{\bm{n}\cdot \bm{u}, v }_{\d \hat{D}}.  
\end{align*}
for any $v\in V_h$.  
Thus, to ensure that this sums to zero, we modify the geometric factors by seeking $J\bm{G}$ which minimizes the $L^2$ error for a degree $N$ polynomial approximation to the true geometric factors, subject to a weakly divergence-free constraint
\begin{align*}
&\min_{\tilde{J\bm{G}}_i \in P^N} \frac{1}{2}\nor{\tilde{J\bm{G}}_i - J\bm{G}_i}_{L^2\LRp{\hat{D}}}^2,\\ 
{\rm s.t.\ } &\LRa{\bm{n}_i,v}_{\d \hat{D}}-\LRp{\tilde{J\bm{G}}_i,\Grad v}_{\hat{D}} = 0, \qquad \forall v\in P^N.
\end{align*}
We note that the constraint corresponding to $v = 1$ yields that $\LRa{\bm{n}_i,v}_{\d \hat{D}} = 0$.  Thus, in order to guarantee a solution to this problem, we require that $\LRa{\bm{n}_i,v}_{\d \hat{D}} = 0$ for consistency of the right hand side.  This is satisfied if the mesh is watertight 
%This is satisfied if the mapping is isoparametric: the cross product formula is exact at quadrature points and the geometric factors are degree $2N-2$ polynomials, which implies that for $v = 1$, $\LRa{\bm{n}_i,v}_{\d \hat{D}}$ is exactly integrated by a surface quadrature of degree $2N$.

This strategy was first introduced in the context of SBP-SAT terms in \cite{fernandez2016simultaneous}.  We approach its implementation slightly differently, and use the fact that the quadratic program can be solved explicitly using the null space method, which is computationally feasible since the null space of the constraint matrix is computed only once on the reference element.  This null space corresponds to a discretely divergence-free basis, which we extract using the SVD.  

The resulting free-stream preserving geometric factors result in separate approximations of the volume and surface geometric factors.  The surface geometric factors are constructed at surface quadrature points, which guarantees that neighboring surface normal terms cancel for watertight meshes.  The volume geometric factors are constructed at quadrature points and projected onto a polynomial basis of degree $N$ with weakly divergence-free constraints involving the surface normals.


\section{Limiting}

The evaluation of $\bm{u}_v = \bm{u}\LRp{\Pi_N v}$ can increase entropy pointwise, such that $S(\bm{u}_v) \geq S(\bm{u})$.  This can manifest as spikes in $\bm{u}_v$.  We wish to mollify the effect of such spikes.  

The first approach is to limit the conservative variable $\bm{u}$
\[
\tilde{\bm{u}} = \bar{\bm{u}} + \Theta (\bm{u} - \bar{\bm{u}})
\]
where $\Theta$ is some diagonal matrix with entries in $[0,1]$.  We want to ensure that $\rho, E-\frac{\rho u^2}{2} > 0$.  

The entropy for the compressible Euler equations is 
\[
U(\bm{u}) = -\frac{\rho s}{\gamma-1},
\]
where $s = \log\LRp{\frac{p}{\rho^\gamma}}$ is the physical specific entropy.  The entropy variables under this choice of entropy are then
\begin{align*}
v_1 = \frac{\gamma-s}{\gamma-1} - \frac{\rho u^2}{2p}, \qquad v_2 = \frac{\rho u}{\rho e}, \qquad v_3 = -\frac{\rho}{\rho e}.
\end{align*}
where the internal energy $\rho e = E - u^2/2$.

The inverse mapping is given by 
\[
\rho = -(\rho e) v_3, \qquad m = (\rho e) v_2, \qquad E = (\rho e)\LRp{1 - \frac{v_2^2}{2 v_3}},
\]
where $\rho e$ and $s$ in terms of the entropy variables are 
\[
\rho e = \LRp{\frac{(\gamma-1)}{\LRp{-v_3}^{\gamma}}}^{1/(\gamma-1)}e^{\frac{-s}{\gamma-1}}, \qquad s = \gamma - v_1 + \frac{v_2^2}{2v_3}.
\]
The mapping is invertible so long as $\rho, E-\frac{\rho u^2}{2} > 0$, which can be ensured using standard limiters.  However, we have to ensure also that $\rho(\Pi_N\bm{v}) > 0$ (similarly for internal energy).  This boils down to ensuring that $\Pi_N v_3(x) < 0$, which guarantees that $(\rho e) > 0$ as well.   

It can be helpful to ensure a stronger condition, that $\Pi_N v_3(x) \leq \max_{x} v_3(x)$.  This guarantees a bound constraint on the conservative variables evaluated using the projected entropy variables.  

Another approach is to change the time-step size based on the difference between $\bm{u}$ and $\bm{u}_v$.  This would be similar to local time-stepping (high order interpolation of the numerical fluxes and multiple evaluations of )

\begin{itemize}
\item Adaptively choose time-step size?
\item Expensive option: bisection or Newton algorithm for finding theta.  
\end{itemize}

\section{Implementation}

The semi-discrete evolution equation is as follows
\[
\pd{\bm{u}}{t} = \LRs{\begin{array}{cc}
\bm{P}_q & \bm{L}_q
\end{array}}
\LRp{
\LRs{
\begin{array}{cc}
2\bm{D}_q & \bm{V}_q\bm{L}_q\\
\bm{V}_f\bm{P}_q & \bm{I}
\end{array} 
}\circ 
\LRs{
\begin{array}{cc}
\bm{f}_{S}(\bm{u},\bm{u}_f) & \bm{f}_{S}(\bm{u},\bm{u}_f)\\
 \bm{f}_{S}(\bm{u},\bm{u}_f) &  \bm{f}_S(\bm{u}_f^+,\bm{u}_f)
\end{array} 
}\bm{1}}.
\]
where $\bm{u}, \bm{u}_f$ are evaluations at volume and surface quadrature points.  

The method is outlined as follows: we store the conservation variables $\bm{u}$ at quadrature points, and compute projected entropy variables $\bm{v}_u = \Pi_N\LRp{\bm{v}(\bm{u})}$ 
\begin{enumerate}
\item Apply volume flux differencing ($\bm{D}_q$ and $\bm{V}_q\bm{L}_q$) and projection ($\bm{V}_q\bm{P}_q$) (volume kernel)
\item Apply surface flux differencing ($\bm{V}_f\bm{P}_q$) and lifting ($\bm{V}_q\bm{L}_q$) (volume kernel)
\item Apply WADG (scale by $1/J$ and apply $\bm{V}_q\bm{P}_q$ and update $\bm{u}$ at volume quad points.  Compute curvilinear projected entropy variables $\bm{v}_u = P_N\bm{v}(\bm{u}) =  \Pi_N\LRp{\frac{1}{J}\Pi_N\LRp{\bm{v}(\bm{u})J}}$, interpolate to volume quad points, and compute conservative variable volume values (update)
\item Interpolate entropy variables at surface quadrature points and write out conservative variable surface values (face).  
\end{enumerate}

\bibliographystyle{unsrt}
\bibliography{dg}


\end{document}


